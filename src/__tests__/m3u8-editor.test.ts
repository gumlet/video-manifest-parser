import { M3U8Editor } from '../m3u8-editor';
import fs from 'fs/promises';

// Helper function to create a complete manifest with playlists
describe('M3U8Editor', () => {
    const m3u8String: { [key: string]: string } = {};

    beforeAll(async () => {
        for (const file of (await fs.readdir('manifests')).filter((file) => file.endsWith('.m3u8'))) {
            m3u8String[file.split('.')[0]] = await fs.readFile(`manifests/${file}`, 'utf-8');
        }
    });

    describe('Basic Parsing', () => {
        it('should parse a valid M3U8 manifest', () => {
            const editor = new M3U8Editor(m3u8String['video_with_audio_and_subtitles']);
            expect(editor.toM3U8()).toBe(m3u8String['video_with_audio_and_subtitles']);
        });

        it('should throw an error for an invalid M3U8 manifest', () => {
            expect(() => new M3U8Editor('#EXTM3U\n#INVALID')).toThrow('Invalid M3U8 manifest');
        });

        it('should parse an M3U8 manifest with no media', () => {
            const editor = new M3U8Editor(m3u8String['video_without_audio_and_subtitles']);
            expect(editor.toM3U8()).toBe(m3u8String['video_without_audio_and_subtitles']);
        });
    });

    describe('Removing Subtitle Track', () => {
        it('should remove one subtitle tracks', () => {
            // eslint-disable-next-line no-useless-escape
            const m3u8ManifestWithoutHiSubtitles = '#EXTM3U\n\n#EXT-X-INDEPENDENT-SEGMENTS\n\n#EXT-X-MEDIA:TYPE=AUDIO,URI=\"68416e832ea48d13d4497276_0_en_192k.m3u8\",GROUP-ID=\"audio_192k\",LANGUAGE=\"en\",NAME=\"English\",DEFAULT=NO,AUTOSELECT=YES,CHARACTERISTICS=\"DEFAULT=YES:AUTOSELECT=YES\",CHANNELS=\"2\"\n\n#EXT-X-MEDIA:TYPE=SUBTITLES,URI=\"68416e832ea48d13d4497276_0_en.m3u8\",GROUP-ID=\"subs\",LANGUAGE=\"en\",NAME=\"English\",DEFAULT=NO,AUTOSELECT=YES,CHARACTERISTICS=\"DEFAULT=YES:AUTOSELECT=YES\"\n\n#EXT-X-STREAM-INF:BANDWIDTH=2283391,AVERAGE-BANDWIDTH=1101888,CODECS=\"avc1.4d401f,mp4a.40.2\",RESOLUTION=1280x720,FRAME-RATE=30.000,VIDEO-RANGE=SDR,AUDIO=\"audio_192k\",SUBTITLES=\"subs\",CLOSED-CAPTIONS=NONE\n68416e832ea48d13d4497276_0_720p.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=4232479,AVERAGE-BANDWIDTH=1909293,CODECS=\"avc1.4d4028,mp4a.40.2\",RESOLUTION=1920x1080,FRAME-RATE=30.000,VIDEO-RANGE=SDR,AUDIO=\"audio_192k\",SUBTITLES=\"subs\",CLOSED-CAPTIONS=NONE\n68416e832ea48d13d4497276_0_1080p.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=959119,AVERAGE-BANDWIDTH=527383,CODECS=\"avc1.4d401e,mp4a.40.2\",RESOLUTION=640x360,FRAME-RATE=30.000,VIDEO-RANGE=SDR,AUDIO=\"audio_192k\",SUBTITLES=\"subs\",CLOSED-CAPTIONS=NONE\n68416e832ea48d13d4497276_0_360p.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=1341115,AVERAGE-BANDWIDTH=685968,CODECS=\"avc1.4d401f,mp4a.40.2\",RESOLUTION=854x480,FRAME-RATE=30.000,VIDEO-RANGE=SDR,AUDIO=\"audio_192k\",SUBTITLES=\"subs\",CLOSED-CAPTIONS=NONE\n68416e832ea48d13d4497276_0_480p.m3u8\n\n#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=77718,AVERAGE-BANDWIDTH=38545,CODECS=\"avc1.4d401e\",RESOLUTION=640x360,VIDEO-RANGE=SDR,CLOSED-CAPTIONS=NONE,URI=\"68416e832ea48d13d4497276_0_360p_iframe.m3u8\"\n#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=110930,AVERAGE-BANDWIDTH=55020,CODECS=\"avc1.4d401f\",RESOLUTION=854x480,VIDEO-RANGE=SDR,CLOSED-CAPTIONS=NONE,URI=\"68416e832ea48d13d4497276_0_480p_iframe.m3u8\"\n#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=190792,AVERAGE-BANDWIDTH=91533,CODECS=\"avc1.4d401f\",RESOLUTION=1280x720,VIDEO-RANGE=SDR,CLOSED-CAPTIONS=NONE,URI=\"68416e832ea48d13d4497276_0_720p_iframe.m3u8\"\n#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=371646,AVERAGE-BANDWIDTH=159917,CODECS=\"avc1.4d4028\",RESOLUTION=1920x1080,VIDEO-RANGE=SDR,CLOSED-CAPTIONS=NONE,URI=\"68416e832ea48d13d4497276_0_1080p_iframe.m3u8\"\n';
            const editor = new M3U8Editor(m3u8String['video_with_audio_and_subtitles']);
            editor.removeSubtitleRendition('hi');
            expect(editor.toM3U8()).toBe(m3u8ManifestWithoutHiSubtitles);
        });
    });

    describe('Removing Audio Track', () => {
        it('should remove one audio track', () => {
            // eslint-disable-next-line no-useless-escape
            const m3u8ManifestWithoutEnAudio = '#EXTM3U\n\n#EXT-X-INDEPENDENT-SEGMENTS\n\n#EXT-X-MEDIA:TYPE=SUBTITLES,URI=\"68416e832ea48d13d4497276_0_en.m3u8\",GROUP-ID=\"subs\",LANGUAGE=\"en\",NAME=\"English\",DEFAULT=NO,AUTOSELECT=YES,CHARACTERISTICS=\"DEFAULT=YES:AUTOSELECT=YES\"\n#EXT-X-MEDIA:TYPE=SUBTITLES,URI=\"68416e832ea48d13d4497276_1_hi.m3u8\",GROUP-ID=\"subs\",LANGUAGE=\"hi\",NAME=\"Hindi\",DEFAULT=NO,AUTOSELECT=YES,CHARACTERISTICS=\"DEFAULT=NO:AUTOSELECT=YES\"\n\n#EXT-X-STREAM-INF:BANDWIDTH=2283391,AVERAGE-BANDWIDTH=1101888,CODECS=\"avc1.4d401f,mp4a.40.2\",RESOLUTION=1280x720,FRAME-RATE=30.000,VIDEO-RANGE=SDR,SUBTITLES=\"subs\",CLOSED-CAPTIONS=NONE\n68416e832ea48d13d4497276_0_720p.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=4232479,AVERAGE-BANDWIDTH=1909293,CODECS=\"avc1.4d4028,mp4a.40.2\",RESOLUTION=1920x1080,FRAME-RATE=30.000,VIDEO-RANGE=SDR,SUBTITLES=\"subs\",CLOSED-CAPTIONS=NONE\n68416e832ea48d13d4497276_0_1080p.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=959119,AVERAGE-BANDWIDTH=527383,CODECS=\"avc1.4d401e,mp4a.40.2\",RESOLUTION=640x360,FRAME-RATE=30.000,VIDEO-RANGE=SDR,SUBTITLES=\"subs\",CLOSED-CAPTIONS=NONE\n68416e832ea48d13d4497276_0_360p.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=1341115,AVERAGE-BANDWIDTH=685968,CODECS=\"avc1.4d401f,mp4a.40.2\",RESOLUTION=854x480,FRAME-RATE=30.000,VIDEO-RANGE=SDR,SUBTITLES=\"subs\",CLOSED-CAPTIONS=NONE\n68416e832ea48d13d4497276_0_480p.m3u8\n\n#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=77718,AVERAGE-BANDWIDTH=38545,CODECS=\"avc1.4d401e\",RESOLUTION=640x360,VIDEO-RANGE=SDR,CLOSED-CAPTIONS=NONE,URI=\"68416e832ea48d13d4497276_0_360p_iframe.m3u8\"\n#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=110930,AVERAGE-BANDWIDTH=55020,CODECS=\"avc1.4d401f\",RESOLUTION=854x480,VIDEO-RANGE=SDR,CLOSED-CAPTIONS=NONE,URI=\"68416e832ea48d13d4497276_0_480p_iframe.m3u8\"\n#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=190792,AVERAGE-BANDWIDTH=91533,CODECS=\"avc1.4d401f\",RESOLUTION=1280x720,VIDEO-RANGE=SDR,CLOSED-CAPTIONS=NONE,URI=\"68416e832ea48d13d4497276_0_720p_iframe.m3u8\"\n#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=371646,AVERAGE-BANDWIDTH=159917,CODECS=\"avc1.4d4028\",RESOLUTION=1920x1080,VIDEO-RANGE=SDR,CLOSED-CAPTIONS=NONE,URI=\"68416e832ea48d13d4497276_0_1080p_iframe.m3u8\"\n';
            const editor = new M3U8Editor(m3u8String['video_with_audio_and_subtitles']);
            editor.removeAudioRendition('en');
            expect(editor.toM3U8()).toBe(m3u8ManifestWithoutEnAudio);
        });
    });

    describe('Removing Video Track', () => {
        it('should remove one video track', () => {
            // eslint-disable-next-line no-useless-escape
            const m3u8ManifestWithout720p = '#EXTM3U\n\n#EXT-X-INDEPENDENT-SEGMENTS\n\n#EXT-X-MEDIA:TYPE=AUDIO,URI=\"68416e832ea48d13d4497276_0_en_192k.m3u8\",GROUP-ID=\"audio_192k\",LANGUAGE=\"en\",NAME=\"English\",DEFAULT=NO,AUTOSELECT=YES,CHARACTERISTICS=\"DEFAULT=YES:AUTOSELECT=YES\",CHANNELS=\"2\"\n\n#EXT-X-MEDIA:TYPE=SUBTITLES,URI=\"68416e832ea48d13d4497276_0_en.m3u8\",GROUP-ID=\"subs\",LANGUAGE=\"en\",NAME=\"English\",DEFAULT=NO,AUTOSELECT=YES,CHARACTERISTICS=\"DEFAULT=YES:AUTOSELECT=YES\"\n#EXT-X-MEDIA:TYPE=SUBTITLES,URI=\"68416e832ea48d13d4497276_1_hi.m3u8\",GROUP-ID=\"subs\",LANGUAGE=\"hi\",NAME=\"Hindi\",DEFAULT=NO,AUTOSELECT=YES,CHARACTERISTICS=\"DEFAULT=NO:AUTOSELECT=YES\"\n\n#EXT-X-STREAM-INF:BANDWIDTH=4232479,AVERAGE-BANDWIDTH=1909293,CODECS=\"avc1.4d4028,mp4a.40.2\",RESOLUTION=1920x1080,FRAME-RATE=30.000,VIDEO-RANGE=SDR,AUDIO=\"audio_192k\",SUBTITLES=\"subs\",CLOSED-CAPTIONS=NONE\n68416e832ea48d13d4497276_0_1080p.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=959119,AVERAGE-BANDWIDTH=527383,CODECS=\"avc1.4d401e,mp4a.40.2\",RESOLUTION=640x360,FRAME-RATE=30.000,VIDEO-RANGE=SDR,AUDIO=\"audio_192k\",SUBTITLES=\"subs\",CLOSED-CAPTIONS=NONE\n68416e832ea48d13d4497276_0_360p.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=1341115,AVERAGE-BANDWIDTH=685968,CODECS=\"avc1.4d401f,mp4a.40.2\",RESOLUTION=854x480,FRAME-RATE=30.000,VIDEO-RANGE=SDR,AUDIO=\"audio_192k\",SUBTITLES=\"subs\",CLOSED-CAPTIONS=NONE\n68416e832ea48d13d4497276_0_480p.m3u8\n\n#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=77718,AVERAGE-BANDWIDTH=38545,CODECS=\"avc1.4d401e\",RESOLUTION=640x360,VIDEO-RANGE=SDR,CLOSED-CAPTIONS=NONE,URI=\"68416e832ea48d13d4497276_0_360p_iframe.m3u8\"\n#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=110930,AVERAGE-BANDWIDTH=55020,CODECS=\"avc1.4d401f\",RESOLUTION=854x480,VIDEO-RANGE=SDR,CLOSED-CAPTIONS=NONE,URI=\"68416e832ea48d13d4497276_0_480p_iframe.m3u8\"\n#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=371646,AVERAGE-BANDWIDTH=159917,CODECS=\"avc1.4d4028\",RESOLUTION=1920x1080,VIDEO-RANGE=SDR,CLOSED-CAPTIONS=NONE,URI=\"68416e832ea48d13d4497276_0_1080p_iframe.m3u8\"\n';
            const editor = new M3U8Editor(m3u8String['video_with_audio_and_subtitles']);
            const uriList = editor.getMediaUris();
            editor.removeVideoRendition(uriList.video[0]);
            expect(editor.toM3U8()).toBe(m3u8ManifestWithout720p);
        });
    });

    describe('Removing any track by URI', () => {
        it('should remove a track by URI', () => {
            // eslint-disable-next-line no-useless-escape
            const m3u8ManifestWithout720p = '#EXTM3U\n\n#EXT-X-INDEPENDENT-SEGMENTS\n\n#EXT-X-MEDIA:TYPE=AUDIO,URI=\"68416e832ea48d13d4497276_0_en_192k.m3u8\",GROUP-ID=\"audio_192k\",LANGUAGE=\"en\",NAME=\"English\",DEFAULT=NO,AUTOSELECT=YES,CHARACTERISTICS=\"DEFAULT=YES:AUTOSELECT=YES\",CHANNELS=\"2\"\n\n#EXT-X-MEDIA:TYPE=SUBTITLES,URI=\"68416e832ea48d13d4497276_0_en.m3u8\",GROUP-ID=\"subs\",LANGUAGE=\"en\",NAME=\"English\",DEFAULT=NO,AUTOSELECT=YES,CHARACTERISTICS=\"DEFAULT=YES:AUTOSELECT=YES\"\n#EXT-X-MEDIA:TYPE=SUBTITLES,URI=\"68416e832ea48d13d4497276_1_hi.m3u8\",GROUP-ID=\"subs\",LANGUAGE=\"hi\",NAME=\"Hindi\",DEFAULT=NO,AUTOSELECT=YES,CHARACTERISTICS=\"DEFAULT=NO:AUTOSELECT=YES\"\n\n#EXT-X-STREAM-INF:BANDWIDTH=4232479,AVERAGE-BANDWIDTH=1909293,CODECS=\"avc1.4d4028,mp4a.40.2\",RESOLUTION=1920x1080,FRAME-RATE=30.000,VIDEO-RANGE=SDR,AUDIO=\"audio_192k\",SUBTITLES=\"subs\",CLOSED-CAPTIONS=NONE\n68416e832ea48d13d4497276_0_1080p.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=959119,AVERAGE-BANDWIDTH=527383,CODECS=\"avc1.4d401e,mp4a.40.2\",RESOLUTION=640x360,FRAME-RATE=30.000,VIDEO-RANGE=SDR,AUDIO=\"audio_192k\",SUBTITLES=\"subs\",CLOSED-CAPTIONS=NONE\n68416e832ea48d13d4497276_0_360p.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=1341115,AVERAGE-BANDWIDTH=685968,CODECS=\"avc1.4d401f,mp4a.40.2\",RESOLUTION=854x480,FRAME-RATE=30.000,VIDEO-RANGE=SDR,AUDIO=\"audio_192k\",SUBTITLES=\"subs\",CLOSED-CAPTIONS=NONE\n68416e832ea48d13d4497276_0_480p.m3u8\n\n#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=77718,AVERAGE-BANDWIDTH=38545,CODECS=\"avc1.4d401e\",RESOLUTION=640x360,VIDEO-RANGE=SDR,CLOSED-CAPTIONS=NONE,URI=\"68416e832ea48d13d4497276_0_360p_iframe.m3u8\"\n#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=110930,AVERAGE-BANDWIDTH=55020,CODECS=\"avc1.4d401f\",RESOLUTION=854x480,VIDEO-RANGE=SDR,CLOSED-CAPTIONS=NONE,URI=\"68416e832ea48d13d4497276_0_480p_iframe.m3u8\"\n#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=371646,AVERAGE-BANDWIDTH=159917,CODECS=\"avc1.4d4028\",RESOLUTION=1920x1080,VIDEO-RANGE=SDR,CLOSED-CAPTIONS=NONE,URI=\"68416e832ea48d13d4497276_0_1080p_iframe.m3u8\"\n';
            const editor = new M3U8Editor(m3u8String['video_with_audio_and_subtitles']);
            editor.removeTrackByUri('68416e832ea48d13d4497276_0_720p.m3u8');
            expect(editor.toM3U8()).toBe(m3u8ManifestWithout720p);
        });
    });

    describe('Adding a new audio track', () => {
        it('should add a new audio track', () => {
            const editor = new M3U8Editor(m3u8String['video_with_audio_and_subtitles']);
            editor.addAudioRendition('audio_192k', 'fr', 'French', '68416e832ea48d13d4497276_0_fr_192k.m3u8', 2);
            expect(editor.toM3U8()).toContain('68416e832ea48d13d4497276_0_fr_192k.m3u8');
        });
    });

    describe('Adding a new subtitle track', () => {
        it('should add a new subtitle track', () => {
            const editor = new M3U8Editor(m3u8String['video_with_audio_and_subtitles']);
            editor.addSubtitleRendition('subs', 'fr', 'French', '68416e832ea48d13d4497276_0_fr.m3u8');
            expect(editor.toM3U8()).toContain('68416e832ea48d13d4497276_0_fr.m3u8');
        });
    });
});
